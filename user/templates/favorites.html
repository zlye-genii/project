<!DOCTYPE html>
<html>
<head>
    <title>Favorites</title>
</head>
<body>
    <h1>Add Media to Favorites</h1>
    <form id="add-favorite-form">
        <label for="media_type">Media Type:</label><br>
        <select id="media_type" name="media_type" onchange="fetchMedia()">
            <option value="movie">Movie</option>
            <option value="book">Book</option>
        </select><br>
        <label for="media_id">Media:</label><br>
        <select id="media_id" name="media_id">
            <!-- Media options will be populated here -->
        </select><br>
        <input type="submit" value="Add to Favorites">
    </form>
    <h1>Remove Media from Favorites</h1>
    <form id="remove-favorite-form">
        <label for="remove_media_type">Media Type:</label><br>
        <select id="remove_media_type" name="remove_media_type" onchange="fetchFavorites()">
            <option value="movie">Movie</option>
            <option value="book">Book</option>
        </select><br>
        <label for="remove_media_id">Media:</label><br>
        <select id="remove_media_id" name="remove_media_id">
            <!-- Favorite media options will be populated here -->
        </select><br>
        <input type="submit" value="Remove from Favorites">
    </form>
    <h1>Your Favorites (by selected media type)</h1>
    <div id="favs-block"></div>
    <script>
        function getCookie(name) {
            const value = '; ' + document.cookie;
            const parts = value.split('; ' + name + '=');
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function fetchMedia() {
            const mediaType = document.getElementById('media_type').value;
            fetch(`/api/${mediaType}s/upcoming/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                const mediaSelect = document.getElementById('media_id');
                mediaSelect.innerHTML = '';
                data.results.forEach(media => {
                    const option = document.createElement('option');
                    option.value = media.id;
                    option.text = media.name; // TODO: DO NOT USE UPCOMING, ITS SPANISH, I DONT KNOW WHY, JUST FEED DATA INTO /DETAILS FIRST THATS MORE RELIABLE, also media.title
                    mediaSelect.add(option);
                });
            });
        }

        function fetchFavorites() {
            const mediaType = document.getElementById('remove_media_type').value;
            fetch(`/api/user/favorites/?media_type=${mediaType}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                const mediaSelect = document.getElementById('remove_media_id');
                const favsBlock = document.getElementById('favs-block')
                mediaSelect.innerHTML = '';
                data.favorites.forEach(media => {
                    const option = document.createElement('option');
                    option.value = media.id;
                    option.text = media.title;
                    mediaSelect.add(option);
                    const p = document.createElement('p')
                    p.innerText = media.title
                    favsBlock.appendChild(p);
                });
            });
        }

        document.getElementById('add-favorite-form').addEventListener('submit', function(event) {
            event.preventDefault();
            fetch('/api/user/favorites/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    media_id: document.getElementById('media_id').value,
                    media_type: document.getElementById('media_type').value
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('message').innerText = data.message || data.error;
            });
        });

        document.getElementById('remove-favorite-form').addEventListener('submit', function(event) {
            event.preventDefault();
            fetch('/api/user/favorites/remove/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    media_id: document.getElementById('remove_media_id').value,
                    media_type: document.getElementById('remove_media_type').value
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('message').innerText = data.message || data.error;
            });
        });
        fetchMedia()
        fetchFavorites()
    </script>
</body>
</html>